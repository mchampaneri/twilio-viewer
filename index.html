<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description"
        content="Easy viewing of Twilio accounts, subaccounts, and related resources (such as message, and voice call logs).">
    <title>Twilio Viewer</title>
    <link rel="icon" type="image/png" href="/icon.png" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vuetify@3.1.6/dist/vuetify.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.1.96/css/materialdesignicons.min.css">

    <style>
        table,
        table .v-list-item-subtitle {
            font-size: .85rem;
        }

        table .v-list-item-title {
            font-size: .9rem;
        }
    </style>
</head>

<body>
    <div id="app">
        <v-app>
            <v-navigation-drawer theme="dark" permanent>
                <v-list>
                    <v-list-item @click="reloadWebsite">
                        <template v-slot:prepend>
                            <v-img src="/icon.svg" height="32" width="32" class="me-2"></v-img>
                            <v-list-item-title style="font-size: 1.25rem;">
                                Twilio Viewer
                            </v-list-item-title>
                        </template>
                    </v-list-item>
                </v-list>
                <v-divider></v-divider>
                <v-list :lines="false">
                    <v-list-item v-for="(navItem, i) in navItems" :key="i" active-color="primary" :to="navItem.path">
                        <template v-slot:prepend>
                            <v-icon :icon="navItem.meta.icon"></v-icon>
                        </template>

                        <v-list-item-title v-text="navItem.name"></v-list-item-title>
                    </v-list-item>
                </v-list>
                <template v-slot:append>
                    <v-divider></v-divider>
                    <div class="text-center pa-2">
                        <a href="https://github.com/sociocs/twilio-viewer" target="_blank"
                            class="text-white text-decoration-none mx-1" title="Code on GitHub.">
                            <v-icon icon="mdi-github"></v-icon>
                        </a>
                        <a href="https://github.com/sociocs/twilio-viewer#twilio-viewer" target="_blank"
                            class="text-white text-decoration-none mx-1" title="Informtion about the tool.">
                            <v-icon icon="mdi-information-outline"></v-icon>
                        </a>
                    </div>
                </template>
            </v-navigation-drawer>

            <router-view></router-view>
        </v-app>
    </div>

    <template id="auth">
        <v-app-bar :title="$route.name"></v-app-bar>

        <v-main>
            <v-container fluid>
                <v-sheet v-if="loading" class="text-center">
                    <v-progress-circular indeterminate color="primary"></v-progress-circular>
                </v-sheet>
                <v-sheet v-else>
                    <v-tabs v-model="tab" color="primary">
                        <v-tab value="new">New</v-tab>
                        <v-tab value="saved">Saved</v-tab>
                    </v-tabs>

                    <v-window v-model="tab">
                        <v-window-item value="new">
                            <v-sheet class="py-4">
                                <v-form @submit.prevent="connect">
                                    <tempalte v-if="!saved_connections?.length">
                                        <v-alert type="info" title="Important Information" icon="mdi-firework"
                                            variant="tonal" class="mb-4">
                                            <template v-slot:text>
                                                <ul>
                                                    <li>- This is an open source FREE tool. Code available on <a
                                                            href="https://github.com/sociocs/twilio-viewer"
                                                            target="_blank">GitHub</a>.</li>
                                                    <li>
                                                        - All your information and data stays locally on your browser.
                                                    </li>
                                                    <li>
                                                        - It uses Twilio APIs directly from the browser to fetch data.
                                                        No third party servers are involved.
                                                    </li>
                                                    <li>
                                                        - A commercial solution (with a FREE plan) for two-way Twilio
                                                        text messaging, bulk messaging and more is available <a
                                                            href="https://www.sociocs.com/" target="_blank">here</a>.
                                                    </li>
                                                </ul>
                                            </template>
                                        </v-alert>
                                    </tempalte>
                                    <v-text-field v-model="form.account_sid" label="Account SID"
                                        :rules="[v => !!v || 'Required.']"></v-text-field>
                                    <v-text-field v-model="form.auth_token" label="Auth token"
                                        :rules="[v => !!v || 'Required.']"></v-text-field>
                                    <v-btn type="submit" class="mt-2" color="primary" :loading="processing"
                                        :disabled="processing">Connect</v-btn>
                                </v-form>
                            </v-sheet>
                            <v-sheet v-if="connect_result.account_info" class="pa-1">
                                <v-card title="Account information">
                                    <v-card-text>
                                        <table is="vue:v-table">
                                            <tbody>
                                                <tr v-for="item in connect_result.account_info">
                                                    <th>{{item.label}}</th>
                                                    <td>{{item.value}}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </v-card-text>
                                </v-card>
                                <v-card title="Save connection (optional)" class="mt-4">
                                    <v-card-text>
                                        <v-alert
                                            text="Note: Twilio account SID and auth token are saved in plain text in your browser's database."
                                            type="warning" :icon="false" class="mb-3"></v-alert>

                                        <v-form @submit.prevent="saveConnection">
                                            <v-text-field v-model="form.connection_name" label="Connection name"
                                                :rules="[v => !!v || 'Required.']"></v-text-field>
                                            <v-btn type="submit" class="mt-2" color="primary" :loading="processing"
                                                :disabled="processing">Save</v-btn>
                                        </v-form>
                                    </v-card-text>
                                </v-card>
                            </v-sheet>
                            <v-sheet v-else-if="connect_result.error">
                                <v-alert type="error" title="Error" :text="connect_result.error"
                                    :icon="false"></v-alert>
                            </v-sheet>
                        </v-window-item>

                        <v-window-item value="saved">
                            <v-sheet v-if="!saved_connections?.length" class="text-center py-4">
                                <v-alert text="There are no records available."></v-alert>
                            </v-sheet>
                            <v-sheet v-else class="py-4">
                                <table is="vue:v-table">
                                    <thead>
                                        <tr>
                                            <th>Account SID</th>
                                            <th>Name</th>
                                            <th class="text-center">Currently using?</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="connection in saved_connections" :key="connection.account_sid">
                                            <td>{{connection.account_sid}}</td>
                                            <td>{{connection.name}}</td>
                                            <td class="text-center">
                                                <v-icon icon="mdi-check-bold" v-if="connection.in_use"
                                                    title="Currently using this account." color="green-darken-2">
                                                </v-icon>
                                                <span v-else>
                                                    <a href="#"
                                                        @click.prevent.stop="switchConnection(connection.account_sid)"
                                                        title="Switch to this account.">Use</a>
                                                </span>
                                            </td>
                                            <td>
                                                <v-btn size="x-small" icon="mdi-delete" color="red"
                                                    title="Remove account."
                                                    @click="removeConnection(connection.account_sid)"
                                                    :loading="removing" :disabled="removing" class="me-5">
                                                </v-btn>
                                                <v-btn size="x-small" icon="mdi-chevron-right" color="secondary"
                                                    title="View subaccounts."
                                                    :to="'/subaccounts/'+ connection.account_sid">
                                                </v-btn>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </v-sheet>
                        </v-window-item>
                    </v-window>
                </v-sheet>
            </v-container>
        </v-main>
    </template>

    <template id="subaccounts">
        <v-app-bar :title="title">
            <template v-slot:prepend>
                <v-btn icon class="hidden-xs-only" @click="$router.back">
                    <v-icon>mdi-arrow-left</v-icon>
                </v-btn>
            </template>
            <template v-slot:append>
                <v-btn icon="mdi-cached" :loading="loading" :disabled="loading" @click="refresh"
                    title="Refresh subaccounts from Twilio.">
                </v-btn>
            </template>
        </v-app-bar>

        <v-main>
            <v-sheet v-if="loading" class="text-center pa-4">
                <v-progress-circular indeterminate color="primary"></v-progress-circular>
            </v-sheet>
            <v-sheet v-else-if="!records?.length" class="text-center pa-4">
                <v-alert text="There are no records available."></v-alert>
            </v-sheet>
            <v-sheet v-else>
                <table is="vue:v-table">
                    <thead>
                        <tr>
                            <th>SID</th>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Created at</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="r in records" :key="r.sid">
                            <td> {{r.sid}}</td>
                            <td>{{r.name}}</td>
                            <td>{{r.status}}</td>
                            <td>{{localDate(r.created_at)}}</td>
                        </tr>
                    </tbody>
                </table>
            </v-sheet>
        </v-main>
    </template>

    <template id="account-info">
        <v-app-bar :title="$route.name">
            <template v-slot:append>
                <v-autocomplete class="mr-2" label="Account" hide-details="auto" density="compact"
                    v-model="active_account_sid" item-title="name" item-value="sid" :items="accounts" variant="solo">
                    <template v-slot:item="{ props, item }">
                        <v-list-item v-bind="props" :title="item?.raw?.name" :subtitle="item?.raw?.sid"></v-list-item>
                    </template>
                </v-autocomplete>

                <v-btn icon="mdi-cached" :loading="loading" :disabled="loading" @click="refresh('reload')"
                    title="Refresh">
                </v-btn>
            </template>
        </v-app-bar>

        <v-main>
            <v-sheet v-if="loading" class="text-center pa-4">
                <v-progress-circular indeterminate color="primary"></v-progress-circular>
            </v-sheet>
            <v-sheet v-else-if="error" class="pa-4">
                <v-alert type="error" title="Error" :text="error" :icon="false"></v-alert>
            </v-sheet>
            <v-sheet v-else-if="!records?.length" class="text-center pa-4">
                <v-alert text="There are no records available."></v-alert>
            </v-sheet>
            <v-sheet v-else>
                <v-card>
                    <v-card-text>
                        <table is="vue:v-table">
                            <tbody>
                                <tr v-for="item in records">
                                    <th>{{item.label}}</th>
                                    <td>{{item.value}}</td>
                                </tr>
                            </tbody>
                        </table>
                    </v-card-text>
                </v-card>
            </v-sheet>
        </v-main>
    </template>

    <template id="phone-numbers">
        <v-app-bar :title="$route.name">
            <template v-slot:append>
                <v-autocomplete class="mr-2" label="Account" hide-details="auto" density="compact"
                    v-model="active_account_sid" item-title="name" item-value="sid" :items="accounts" variant="solo">
                    <template v-slot:item="{ props, item }">
                        <v-list-item v-bind="props" :title="item?.raw?.name" :subtitle="item?.raw?.sid"></v-list-item>
                    </template>
                </v-autocomplete>

                <v-btn icon="mdi-cached" :loading="loading" :disabled="loading" @click="refresh('reload')"
                    title="Refresh">
                </v-btn>
            </template>
        </v-app-bar>

        <v-main>
            <v-sheet v-if="loading" class="text-center pa-4">
                <v-progress-circular indeterminate color="primary"></v-progress-circular>
            </v-sheet>
            <v-sheet v-else-if="error" class="pa-4">
                <v-alert type="error" title="Error" :text="error" :icon="false"></v-alert>
            </v-sheet>
            <v-sheet v-else-if="!records?.length" class="text-center pa-4">
                <v-alert text="There are no records available."></v-alert>
            </v-sheet>
            <v-sheet v-else>
                <table is="vue:v-table">
                    <thead>
                        <tr>
                            <th>SID</th>
                            <th>Phone number</th>
                            <th>Capabilities</th>
                            <th>Webhook URLs</th>
                            <th>Status</th>
                            <th>Date created</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="r in records" :key="r.sid">
                            <td>
                                <div style="max-width: 100px;" class="text-truncate" :title="r.sid">
                                    {{r.sid}}
                                </div>
                            </td>
                            <td>{{r.phone_number}}</td>
                            <td>
                                <v-list lines="one" density="compact" variant="text" class="py-0">
                                    <v-list-item v-for="c in capabilities(r.capabilities)" :key="c.label"
                                        :title="c.label" :subtitle="c.value" class="px-0"></v-list-item>
                                </v-list>
                            <td>
                                <v-list lines="one" density="compact" variant="text" class="py-0">
                                    <v-list-item v-for="url in urls(r)" :key="url.label" :title="url.label"
                                        :subtitle="url.value" class="px-0 text-truncate"></v-list-item>
                                </v-list>
                            </td>
                            <td>{{r.status}}</td>
                            <td :title="r.date_created">{{localDate(r.date_created)}}</td>
                        </tr>
                    </tbody>
                </table>
            </v-sheet>
        </v-main>
    </template>

    <template id="messaging-services">
        <v-app-bar :title="$route.name">
            <template v-slot:append>
                <v-autocomplete class="mr-2" label="Account" hide-details="auto" density="compact"
                    v-model="active_account_sid" item-title="name" item-value="sid" :items="accounts" variant="solo">
                    <template v-slot:item="{ props, item }">
                        <v-list-item v-bind="props" :title="item?.raw?.name" :subtitle="item?.raw?.sid"></v-list-item>
                    </template>
                </v-autocomplete>

                <v-btn icon="mdi-cached" :loading="loading" :disabled="loading" @click="refresh('reload')"
                    title="Refresh">
                </v-btn>
            </template>
        </v-app-bar>

        <v-main>
            <v-sheet v-if="loading" class="text-center pa-4">
                <v-progress-circular indeterminate color="primary"></v-progress-circular>
            </v-sheet>
            <v-sheet v-else-if="error" class="pa-4">
                <v-alert type="error" title="Error" :text="error" :icon="false"></v-alert>
            </v-sheet>
            <v-sheet v-else-if="!records?.length" class="text-center pa-4">
                <v-alert text="There are no records available."></v-alert>
            </v-sheet>
            <v-sheet v-else>
                <table is="vue:v-table">
                    <thead>
                        <tr>
                            <th>SID</th>
                            <th>Friendly name</th>
                            <th>Settings</th>
                            <th>Webhook URLs</th>
                            <th>Date created</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="r in records" :key="r.sid">
                            <td>
                                <div style="max-width: 100px;" class="text-truncate" :title="r.sid">
                                    {{r.sid}}
                                </div>
                            </td>
                            <td>{{r.friendly_name}}</td>
                            <td>
                                <v-list lines="one" density="compact" variant="text" class="py-0">
                                    <v-list-item v-for="c in settings(r)" :key="c.label" :title="c.label"
                                        :subtitle="c.value" class="px-0"></v-list-item>
                                </v-list>
                            <td>
                                <v-list lines="one" density="compact" variant="text" class="py-0">
                                    <v-list-item v-for="url in urls(r)" :key="url.label" :title="url.label"
                                        :subtitle="url.value" class="px-0 text-truncate"></v-list-item>
                                </v-list>
                            </td>
                            <td :title="r.date_created">{{localDate(r.date_created)}}</td>
                        </tr>
                    </tbody>
                </table>
            </v-sheet>
        </v-main>
    </template>

    <template id="message-history">
        <v-app-bar :title="$route.name">
            <template v-slot:append>
                <v-autocomplete class="mr-2" label="Account" hide-details="auto" density="compact"
                    v-model="active_account_sid" item-title="name" item-value="sid" :items="accounts" variant="solo">
                    <template v-slot:item="{ props, item }">
                        <v-list-item v-bind="props" :title="item?.raw?.name" :subtitle="item?.raw?.sid"></v-list-item>
                    </template>
                </v-autocomplete>
                <v-btn icon="mdi-cached" :loading="loading" :disabled="loading" @click="refresh('reload')"
                    title="Refresh">
                </v-btn>
            </template>
        </v-app-bar>

        <v-main>
            <v-sheet v-if="loading" class="text-center pa-4">
                <v-progress-circular indeterminate color="primary"></v-progress-circular>
            </v-sheet>
            <v-sheet v-else-if="error" class="pa-4">
                <v-alert type="error" title="Error" :text="error" :icon="false"></v-alert>
            </v-sheet>
            <v-sheet v-else>
                <v-container>
                    <v-form @submit.prevent="search">
                        <v-row align="center">
                            <v-col>
                                <v-text-field v-model="form.from" label="From number" hide-details="auto"
                                    density="compact" placeholder="e.g. 16319999998"></v-text-field>
                            </v-col>

                            <v-col>
                                <v-text-field v-model="form.to" label="To number" hide-details="auto" density="compact"
                                    placeholder="e.g. 16319999999"></v-text-field>
                            </v-col>

                            <v-col>
                                <v-text-field v-model="form.from_date" label="From date" hide-details="auto" type="date"
                                    density="compact" placeholder="e.g. 2023-03-01"></v-text-field>
                            </v-col>

                            <v-col>
                                <v-text-field v-model="form.to_date" label="To date" hide-details="auto" type="date"
                                    density="compact" placeholder="e.g. 2023-03-02"></v-text-field>
                            </v-col>

                            <v-col cols="12" md="1">
                                <v-btn type="submit" variant="outlined" color="primary" :loading="searching"
                                    :disabled="searching">Search</v-btn>
                            </v-col>
                        </v-row>
                    </v-form>
                </v-container>

                <v-sheet v-if="!records?.length" class="text-center pa-4">
                    <v-alert text="There are no records available."></v-alert>
                </v-sheet>

                <table v-else is="vue:v-table">
                    <thead>
                        <tr>
                            <th>SID</th>
                            <th class="text-center">Direction</th>
                            <th>From</th>
                            <th>To</th>
                            <th>Body</th>
                            <th>Date</th>
                            <th class="text-center">Segments</th>
                            <th class="text-center">Status</th>
                            <th class="text-center">Price</th>
                        </tr>
                    </thead>

                    <tbody>
                        <tr v-for="r in records" :key="r.sid">
                            <td>
                                <div style="max-width: 100px;" class="text-truncate" :title="r.sid">
                                    {{r.sid}}
                                </div>
                            </td>
                            <td class="text-center">{{r.direction}}</td>
                            <td>{{r.from}}</td>
                            <td>{{r.to}}</td>
                            <td>
                                <div v-if="r.body">
                                    {{r.body}}
                                </div>
                                <template v-if="hasMedia(r.num_media)">
                                    <template v-if="r.media_loading">
                                        <v-progress-circular indeterminate color="primary"></v-progress-circular>
                                    </template>
                                    <template v-else-if="r.media_list">
                                        <v-list lines="one">
                                            <v-list-item :href="media.link" target="_blank"
                                                v-for="media in r.media_list" :key="media.sid" :title="media.sid"
                                                :subtitle="media.content_type">
                                                <template v-slot:prepend>
                                                    <v-icon color="primary" :icon="icon(media.content_type)"></v-icon>
                                                </template>
                                            </v-list-item>
                                        </v-list>
                                    </template>
                                    <template v-else>
                                        <v-btn variant="text" icon="mdi-attachment" @click="refreshMediaList(r.sid)">
                                        </v-btn>
                                    </template>
                                </template>
                            </td>
                            <td :title="r.date_updated">{{localDate(r.date_updated)}}</td>
                            <td class="text-center">{{r.num_segments}}</td>
                            <td class="text-center">
                                <div>
                                    {{r.status}}
                                </div>
                                <template v-if="r.error_message">
                                    <span class="text-error">
                                        {{r.error_message}}
                                    </span>
                                </template>
                                <template v-if="r.error_code">
                                    <div>
                                        <v-chip class="my-1" size="small" color="error"
                                            :href="errorPageUrl(r.error_code)" target="_blank">
                                            Error code {{r.error_code}}
                                        </v-chip>
                                    </div>
                                </template>
                            </td>
                            <td class="text-center">{{price(r)}}</td>
                        </tr>
                    </tbody>
                </table>
                <v-layout v-if="next_page_uri" v-intersect="loadMore">
                    <v-progress-linear indeterminate height="6"></v-progress-linear>
                </v-layout>
            </v-sheet>
        </v-main>
    </template>

    <template id="voice-call-history">
        <v-app-bar :title="$route.name">
            <template v-slot:append>
                <v-autocomplete class="mr-2" label="Account" hide-details="auto" density="compact"
                    v-model="active_account_sid" item-title="name" item-value="sid" :items="accounts" variant="solo">
                    <template v-slot:item="{ props, item }">
                        <v-list-item v-bind="props" :title="item?.raw?.name" :subtitle="item?.raw?.sid"></v-list-item>
                    </template>
                </v-autocomplete>
                <v-btn icon="mdi-cached" :loading="loading" :disabled="loading" @click="refresh('reload')"
                    title="Refresh">
                </v-btn>
            </template>
        </v-app-bar>

        <v-main>
            <v-sheet v-if="loading" class="text-center pa-4">
                <v-progress-circular indeterminate color="primary"></v-progress-circular>
            </v-sheet>
            <v-sheet v-else-if="error" class="pa-4">
                <v-alert type="error" title="Error" :text="error" :icon="false"></v-alert>
            </v-sheet>
            <v-sheet v-else>
                <v-container>
                    <v-form @submit.prevent="search">
                        <v-row align="center">
                            <v-col>
                                <v-text-field v-model="form.from" label="From number" hide-details="auto"
                                    density="compact" placeholder="e.g. 16319999998"></v-text-field>
                            </v-col>

                            <v-col>
                                <v-text-field v-model="form.to" label="To number" hide-details="auto" density="compact"
                                    placeholder="e.g. 16319999999"></v-text-field>
                            </v-col>

                            <v-col>
                                <v-text-field v-model="form.from_date" label="From date" hide-details="auto" type="date"
                                    density="compact" placeholder="e.g. 2023-03-01"></v-text-field>
                            </v-col>

                            <v-col>
                                <v-text-field v-model="form.to_date" label="To date" hide-details="auto" type="date"
                                    density="compact" placeholder="e.g. 2023-03-02"></v-text-field>
                            </v-col>

                            <v-col cols="12" md="1">
                                <v-btn type="submit" variant="outlined" color="primary" :loading="searching"
                                    :disabled="searching">Search</v-btn>
                            </v-col>
                        </v-row>
                    </v-form>
                </v-container>

                <v-sheet v-if="!records?.length" class="text-center pa-4">
                    <v-alert text="There are no records available."></v-alert>
                </v-sheet>

                <table v-else is="vue:v-table">
                    <thead>
                        <tr>
                            <th>SID</th>
                            <th class="text-center">Direction</th>
                            <th>From</th>
                            <th>To</th>
                            <th>Start time</th>
                            <th>End time</th>
                            <th class="text-center">Duration</th>
                            <th class="text-center">Status</th>
                            <th class="text-center">Price</th>
                        </tr>
                    </thead>

                    <tbody>
                        <tr v-for="r in records" :key="r.sid">
                            <td>
                                <div style="max-width: 100px;" class="text-truncate" :title="r.sid">
                                    {{r.sid}}
                                </div>
                            </td>
                            <td class="text-center">{{r.direction}}</td>
                            <td>{{r.from}}</td>
                            <td>{{r.to}}</td>
                            <td :title="r.start_time">{{localDate(r.start_time)}}</td>
                            <td :title="r.end_time">{{localDate(r.end_time)}}</td>
                            <td class="text-center">{{duration(r.duration)}}</td>
                            <td class="text-center">{{r.status}}</td>
                            <td class="text-center">{{price(r)}}</td>
                        </tr>
                    </tbody>
                </table>
                <v-layout v-if="next_page_uri" v-intersect="loadMore">
                    <v-progress-linear indeterminate height="6"></v-progress-linear>
                </v-layout>
            </v-sheet>
        </v-main>
    </template>

    <template id="alerts">
        <v-app-bar :title="$route.name">
            <template v-slot:append>
                <v-select class="mr-2" label="Account" hide-details="auto" density="compact"
                    v-model="active_account_sid" item-title="name" item-value="sid" :items="accounts" variant="solo"
                    :disabled="true">
                </v-select>
                <v-btn icon="mdi-cached" :loading="loading" :disabled="loading" @click="refresh('reload')"
                    title="Refresh">
                </v-btn>
            </template>
        </v-app-bar>

        <v-main>
            <v-sheet v-if="loading" class="text-center pa-4">
                <v-progress-circular indeterminate color="primary"></v-progress-circular>
            </v-sheet>
            <v-sheet v-else-if="error" class="pa-4">
                <v-alert type="error" title="Error" :text="error" :icon="false"></v-alert>
            </v-sheet>
            <v-sheet v-else>
                <v-container>
                    <v-form @submit.prevent="search">
                        <v-row align="center">
                            <v-col>
                                <v-select v-model="form.log_level" :items="log_level_options" item-title="label"
                                    item-value="value" label="Log level" hide-details="auto" density="compact"
                                    single-line></v-select>
                            </v-col>

                            <v-col>
                                <v-text-field v-model="form.from_date" label="From date" hide-details="auto" type="date"
                                    density="compact" placeholder="e.g. 2023-03-01"></v-text-field>
                            </v-col>

                            <v-col>
                                <v-text-field v-model="form.to_date" label="To date" hide-details="auto" type="date"
                                    density="compact" placeholder="e.g. 2023-03-02"></v-text-field>
                            </v-col>

                            <v-col cols="12" md="1">
                                <v-btn type="submit" variant="outlined" color="primary" :loading="searching"
                                    :disabled="searching">Search</v-btn>
                            </v-col>
                        </v-row>
                    </v-form>
                </v-container>

                <v-sheet v-if="!records?.length" class="text-center pa-4">
                    <v-alert text="There are no records available."></v-alert>
                </v-sheet>

                <table v-else is="vue:v-table">
                    <thead>
                        <tr>
                            <th class="text-center">Level</th>
                            <th>Resource SID</th>
                            <th>Date</th>
                            <th>Alert text</th>
                            <th class="text-center">Error code</th>
                        </tr>
                    </thead>

                    <tbody>
                        <tr v-for="r in records" :key="r.sid">
                            <td class="text-center">{{r.log_level}}</td>
                            <td>
                                <div style="max-width: 100px;" class="text-truncate" :title="r.resource_sid">
                                    {{r.resource_sid}}
                                </div>
                            </td>
                            <td :title="r.date_generated">{{localDate(r.date_generated)}}</td>
                            <td>
                                <v-list lines="one" density="compact" variant="text" class="py-0">
                                    <v-list-item v-for="item in alertTextTokens(r.alert_text)" :key="item.label"
                                        :title="item.label" :subtitle="item.value"
                                        class="px-0 text-truncate"></v-list-item>
                                </v-list>
                            </td>
                            <td class="text-center">
                                <a v-if="r.more_info" :href="r.more_info" target="_blank">{{r.error_code}}</a>
                                <span v-else-if="r.error_code">{{r.error_code}}</span>
                                <span v-else>None</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <v-layout v-if="next_page_url" v-intersect="loadMore">
                    <v-progress-linear indeterminate height="6"></v-progress-linear>
                </v-layout>
            </v-sheet>
        </v-main>
    </template>

    <template id="events">
        <v-app-bar :title="$route.name">
            <template v-slot:append>
                <v-select class="mr-2" label="Account" hide-details="auto" density="compact"
                    v-model="active_account_sid" item-title="name" item-value="sid" :items="accounts" variant="solo"
                    :disabled="true">
                </v-select>
                <v-btn icon="mdi-cached" :loading="loading" :disabled="loading" @click="refresh('reload')"
                    title="Refresh">
                </v-btn>
            </template>
        </v-app-bar>

        <v-main>
            <v-sheet v-if="loading" class="text-center pa-4">
                <v-progress-circular indeterminate color="primary"></v-progress-circular>
            </v-sheet>
            <v-sheet v-else-if="error" class="pa-4">
                <v-alert type="error" title="Error" :text="error" :icon="false"></v-alert>
            </v-sheet>
            <v-sheet v-else>
                <v-container>
                    <v-form @submit.prevent="search">
                        <v-row align="center">
                            <v-col>
                                <v-text-field v-model="form.event_type" label="Event type" hide-details="auto"
                                    density="compact" placeholder="e.g. phone-number.updated"></v-text-field>
                            </v-col>

                            <v-col cols="12" md="4">
                                <v-text-field v-model="form.resource_sid" label="Resource SID" hide-details="auto"
                                    density="compact" placeholder="e.g. PN12345..."></v-text-field>
                            </v-col>

                            <v-col cols="12" md="2">
                                <v-text-field v-model="form.from_date" label="From date" hide-details="auto" type="date"
                                    density="compact" placeholder="e.g. 2023-03-01"></v-text-field>
                            </v-col>

                            <v-col cols="12" md="2">
                                <v-text-field v-model="form.to_date" label="To date" hide-details="auto" type="date"
                                    density="compact" placeholder="e.g. 2023-03-02"></v-text-field>
                            </v-col>

                            <v-col cols="12" md="1">
                                <v-btn type="submit" variant="outlined" color="primary" :loading="searching"
                                    :disabled="searching">Search</v-btn>
                            </v-col>
                        </v-row>
                    </v-form>
                </v-container>

                <v-sheet v-if="!records?.length" class="text-center pa-4">
                    <v-alert text="There are no records available."></v-alert>
                </v-sheet>

                <table v-else is="vue:v-table">
                    <thead>
                        <tr>
                            <th class="text-center">Event type</th>
                            <th>Resource SID</th>
                            <th>Date</th>
                            <th class="text-center">Source</th>
                            <th>Actor</th>
                            <th>Description</th>
                            <th>More info</th>
                        </tr>
                    </thead>

                    <tbody>
                        <tr v-for="r in records" :key="r.sid">
                            <td class="text-center">{{r.event_type}}</td>
                            <td>
                                <div style="max-width: 100px;" class="text-truncate" :title="r.resource_sid">
                                    {{r.resource_sid}}
                                </div>
                            </td>
                            <td :title="r.event_date">{{localDate(r.event_date)}}</td>
                            <td class="text-center">{{r.source}}</td>
                            <td>{{actor(r)}}</td>
                            <td>{{r.description}}</td>
                            <td>
                                <v-list lines="one" density="compact" variant="text" class="py-0">
                                    <v-list-item v-for="item in eventDataItems(r.event_data)" :key="item.label"
                                        :title="item.label" :subtitle="item.value"
                                        class="px-0 text-truncate"></v-list-item>
                                </v-list>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <v-layout v-if="next_page_url" v-intersect="loadMore">
                    <v-progress-linear indeterminate height="6"></v-progress-linear>
                </v-layout>
            </v-sheet>
        </v-main>
    </template>

    <template id="billing">
        <v-app-bar :title="$route.name">
            <template v-slot:append>
                <v-sheet color="green-lighten-3" rounded class="pa-1 ps-3 mr-4 d-flex align-center">
                    <span class="mr-2 font-weight-bold">Balance</span>
                    <span class="mr-2" v-if="!refreshingBalance">{{balanceStr()}}</span>
                    <v-btn size="small" variant="text" icon="mdi-cached" :loading="refreshingBalance"
                        :disabled="refreshingBalance" @click="balanceRefresh('reload')" title="Refresh balance.">
                </v-sheet>
                <v-select class="mr-2" label="Account" hide-details="auto" density="compact"
                    v-model="active_account_sid" item-title="name" item-value="sid" :items="accounts" variant="solo">
                </v-select>
                </v-btn>
            </template>
        </v-app-bar>

        <v-main>
            <v-container>
                <v-form @submit.prevent="refresh('reload')">
                    <v-row align="center">
                        <v-col cols="12" md="3">
                            <v-sheet class="mb-1">
                                <v-chip :ripple="false" link size="small" class="me-1" @click="setDates('tm')">
                                    This month
                                </v-chip>
                                <v-chip :ripple="false" link size="small" class="me-1" @click="setDates('tq')">
                                    This quarter
                                </v-chip>
                                <v-chip :ripple="false" link size="small" @click="setDates('ty')">
                                    This year
                                </v-chip>
                            </v-sheet>
                            <v-sheet>
                                <v-chip :ripple="false" link size="small" class="me-1" @click="setDates('lm')">
                                    Last month
                                </v-chip>
                                <v-chip :ripple="false" link size="small" class="me-1" @click="setDates('lq')">
                                    Last quarter
                                </v-chip>
                                <v-chip :ripple="false" link size="small" @click="setDates('ly')">
                                    Last year
                                </v-chip>
                            </v-sheet>
                        </v-col>

                        <v-col cols="12" md="2">
                            <v-text-field v-model="form.from_date" label="From date" hide-details="auto" type="date"
                                density="compact" placeholder="e.g. 2023-03-01"></v-text-field>
                        </v-col>

                        <v-col cols="12" md="2">
                            <v-text-field v-model="form.to_date" label="To date" hide-details="auto" type="date"
                                density="compact" placeholder="e.g. 2023-03-02"></v-text-field>
                        </v-col>

                        <v-col cols="12" md="3">
                            <v-checkbox v-model="form.include_subaccounts" label="Include subaccounts"
                                hide-details="auto"></v-checkbox>
                        </v-col>

                        <v-col cols="12" md="2">
                            <v-btn type="submit" variant="outlined" color="primary" :loading="loading"
                                :disabled="loading">Go</v-btn>
                        </v-col>
                    </v-row>
                </v-form>
            </v-container>

            <v-sheet v-if="loading" class="text-center pa-4">
                <v-progress-circular indeterminate color="primary"></v-progress-circular>
            </v-sheet>
            <v-sheet v-else-if="error" class="pa-4">
                <v-alert type="error" title="Error" :text="error" :icon="false"></v-alert>
            </v-sheet>
            <v-sheet v-else-if="!records.length" class="text-center pa-4">
                <v-alert text="There are no records available."></v-alert>
            </v-sheet>

            <table v-else is="vue:v-table">
                <thead>
                    <tr>
                        <th colspan="3">Category</th>
                        <th class="text-left">Count</th>
                        <th class="text-left">Chargeable Qty</th>
                        <th class="text-right">Cost</th>
                        <th class="text-center">As of</th>
                    </tr>
                </thead>

                <tbody>
                    <template v-for="item in records">
                        <tr class="font-weight-bold">
                            <td colspan="7">{{item.group}}</td>
                        </tr>

                        <tr v-for="r in item.children">
                            <template v-if="r.level===1">
                                <td colspan="3" :title="r.category_desc">
                                    {{r.description}}
                                </td>
                            </template>
                            <template v-else-if="r.level===2">
                                <td></td>
                                <td colspan="2" :title="r.category_desc">
                                    {{r.description}}
                                </td>
                            </template>
                            <template v-else>
                                <td></td>
                                <td></td>
                                <td :title="r.category_desc">{{r.description}}</td>
                            </template>
                            <td class="text-left">{{count(r)}}</td>
                            <td class="text-left">{{usage(r)}}</td>
                            <td class="text-right">{{price(r)}}</td>
                            <td class="text-center" :title="r.as_of">{{localDate(r.as_of)}}</td>
                        </tr>
                    </template>
                </tbody>

                <tfoot class="font-weight-bold">
                    <tr>
                        <td>Total</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td class="text-right">{{price(totals_record)}}</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </v-main>
    </template>

    <script type="importmap">
        { "imports": {
            "vue":        "https://cdn.jsdelivr.net/npm/vue@3.2.47/dist/vue.esm-browser.js",
            "@vue/devtools-api": "https://cdn.jsdelivr.net/npm/@vue/devtools-api@6.5.0/lib/esm/index.min.js",
            "vue-router": "https://cdn.jsdelivr.net/npm/vue-router@4.1.6/dist/vue-router.esm-browser.js",
            "vuetify": "https://cdn.jsdelivr.net/npm/vuetify@3.1.6/dist/vuetify.esm.js",
            "billing-category-map": "/billing-category-map.js"
        } }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.3/dist/dexie.min.js"></script>

    <script type="module">
        import {createApp, nextTick} from "vue";
        import {createRouter, createWebHistory} from "vue-router";
        import {createVuetify} from "vuetify";
        import {billingCategoryMap} from "billing-category-map";

        const db = new Dexie("twilio-viewer-db");

        // db schema
        db.version(2).stores({
            connections: `account_sid,name`,
            subaccounts: `sid,owner_account_sid,name`,
        });

        // a basic store for shared data
        const store = {
            account_sid: "",
            active_account_sid: "",
            auth_token: "",
            connection_name: "",
            subaccounts: [],
            getActiveAccountSid() {
                return this.active_account_sid || this.account_sid;
            },
            getAccounts() {
                return [{sid: this.account_sid, name: this.connection_name}].concat(this.subaccounts);
            },
            async reloadSubaccounts({persist}) {
                const [error, result] = await callTwilioAPI({path: `/2010-04-01/Accounts.json`, cache: "reload"});
                if (error) {
                    return [error, null];
                } else {
                    this.subaccounts = [];
                    for (let i = 0; i < result.accounts?.length; i++) {
                        const account = result.accounts[i];

                        if (account.sid !== account.owner_account_sid) {
                            this.subaccounts.push({
                                sid: account.sid,
                                owner_account_sid: account.owner_account_sid,
                                name: account.friendly_name,
                                status: account.status,
                                created_at: (new Date(account.date_created)).getTime(),
                                loaded_at: Date.now(),
                            });
                        }
                    }

                    if (persist) {
                        await this.pushSubaccountsToDB();
                    }

                    return [null, this.subaccounts.length];
                }
            },
            async pushSubaccountsToDB() {
                await db.subaccounts.bulkPut(this.subaccounts);
            }
        };

        // converts an object to array of label value pair
        function toLabelValArray(object, keys) {
            const result = [];

            for (let i = 0; i < keys?.length; i++) {
                const key = keys[i];

                result.push({label: key.toString(), value: object[key]?.toString() || "None"});
            }

            return result;
        }

        // converts a nested object to flat one, useful when rendering data
        const flattenObject = (ob) => {
            let result = {};

            for (const i in ob) {
                if (typeof ob[i] === 'object' && !Array.isArray(ob[i])) {
                    const temp = flattenObject(ob[i]);
                    for (const j in temp) {
                        result[i + '.' + j] = temp[j];
                    }
                }
                else {
                    result[i] = ob[i];
                }
            }

            return result;
        };

        // calls given Twilio API path
        // when credentials are not passed, reads it from the store
        async function callTwilioAPI({baseUrl, path, method, body, authCredentials, cache}) {
            try {
                const resp = await fetch(`${baseUrl || "https://api.twilio.com"}${path}`, {
                    method: method || "GET",
                    mode: "cors",
                    cache: cache || "force-cache",
                    credentials: "omit", // do not negotiate using browser popup based credential
                    headers: {
                        "Authorization": "Basic " + btoa((authCredentials?.account_sid || store.account_sid) + ":" + (authCredentials?.auth_token || store.auth_token)),
                    },
                    body,
                });

                if (resp.ok) {
                    return [null, (await resp.json())];
                } else {
                    return [`${resp.status} ${resp.statusText}`, null];
                }
            } catch (error) {
                return [error, null];
            }
        }

        function localDate(value) {
            return (new Date(value)).toLocaleString();
        }

        const priceFormatter = new Intl.NumberFormat('en-US', {
            minimumFractionDigits: 4,
            maximumFractionDigits: 4,
        });

        function formatPrice(value) {
            if (isNaN(value)) {
                value = parseFloat(value);
            }

            return priceFormatter.format(value);
        }

        // auth component
        const Auth = {
            template: "#auth",

            data() {
                return {
                    tab: "new",
                    loading: true,
                    processing: false,
                    removeConfirmationDialog: false,
                    removing: false,
                    form: {
                        account_sid: "",
                        auth_token: "",
                        connection_name: "",
                    },
                    saved_connections: [],
                    connect_result: {},
                };
            },

            async created() {
                this.loading = true;

                await this.refreshSavedConnections();

                if (this.saved_connections.length) {
                    this.tab = "saved";
                }

                this.loading = false;
            },

            computed: {
                newTabActive() {
                    return this.tab === "new";
                },

                savedTabActive() {
                    return this.tab === "saved";
                }
            },

            methods: {
                async refreshSavedConnections() {
                    // primary connection
                    const connections = await db.connections.orderBy("name").toArray();

                    if (connections?.length) {
                        const connectionInUse = connections.find(x => x.in_use === true);
                        store.account_sid = connectionInUse?.account_sid;
                        store.auth_token = connectionInUse?.auth_token;
                        store.connection_name = connectionInUse?.name;
                    }

                    this.saved_connections = connections || [];

                    // accounts
                    if (store.account_sid) {
                        store.subaccounts = await db.subaccounts.where({owner_account_sid: store.account_sid}).sortBy("name");
                    }
                },

                async dbResetInUse() {
                    await db.connections.toCollection().modify({in_use: false});
                },

                resetFormData() {
                    this.form.account_sid = "";
                    this.form.auth_token = "";
                    this.form.connection_name = "";
                    this.connect_result = {};
                },

                async connect() {
                    if (!this.form.account_sid || !this.form.auth_token) {
                        return;
                    }

                    this.processing = true;
                    this.connect_result = {};

                    const [error, result] = await callTwilioAPI({path: `/2010-04-01/Accounts/${this.form.account_sid}.json`, authCredentials: this.form, cache: "reload"});

                    if (error) {
                        this.connect_result.error = error;
                    }
                    else if (result.status) {
                        this.connect_result.account_info = toLabelValArray(result, ["friendly_name", "status", "date_created"]);
                        this.form.connection_name = result.friendly_name;
                        store.account_sid = this.form.account_sid;
                        store.auth_token = this.form.auth_token;
                        store.connection_name = this.form.connection_name;

                        // fetch and keep subaccounts in store
                        const [error1, result1] = await store.reloadSubaccounts({persist: false});
                        if (error1) {
                            this.connect_result.error = error1;
                        } else {
                            this.connect_result.account_info.push({
                                label: "subaccount_count",
                                value: result1,
                            });
                        }
                    }

                    this.processing = false;
                },

                async saveConnection() {
                    if (!this.form.account_sid || !this.form.auth_token || !this.form.connection_name) {
                        return;
                    }

                    // remove in_use from other records
                    await this.dbResetInUse();

                    // save connection
                    const connection = {account_sid: store.account_sid, auth_token: store.auth_token, name: this.form.connection_name, in_use: true, created_at: Date.now()};
                    await db.connections.put(connection);

                    // save subaccounts
                    if (store.subaccounts) {
                        await store.pushSubaccountsToDB();
                    }

                    // refresh connections locally
                    await this.refreshSavedConnections();

                    // switch to saved tab
                    this.tab = "saved";

                    // reset form
                    this.resetFormData();
                },

                async switchConnection(accountSid) {
                    // remove in_use from other records
                    await this.dbResetInUse();

                    // update in_use in the db for the selected connection
                    await db.connections.update(accountSid, {in_use: true});

                    // refresh connections locally
                    await this.refreshSavedConnections();
                },

                async removeConnection(accountSid) {
                    this.removing = true;

                    // delete connection
                    await db.connections.delete(accountSid);

                    // if the connection was in use, switch to another one
                    const connection = this.saved_connections.find(x => x.account_sid === accountSid);
                    if (connection.in_use) {
                        // change first record by name to default
                        await this.dbResetInUse();
                        const newDefault = await db.connections.orderBy("name").limit(1).toArray();
                        if (newDefault?.length) {
                            await db.connections.update(newDefault[0].account_sid, {in_use: true});
                        }
                    }

                    // refresh connections locally
                    await this.refreshSavedConnections();

                    this.removing = false;
                }
            },
        };

        // subaccounts component
        const Subaccounts = {
            template: "#subaccounts",

            data() {
                return {
                    title: `Subaccounts`,
                    loading: true,
                    records: [],
                };
            },

            async created() {
                this.loading = true;
                const owner_account_sid = this.$route.params.owner_account_sid;

                // get account
                const account = await db.connections.get(owner_account_sid);
                this.title += ` for ${account.name}`;

                // get subaccounts
                const subaccounts = await db.subaccounts.where({owner_account_sid}).sortBy("name");
                for (let i = 0; i < subaccounts?.length; i++) {
                    const subaccount = subaccounts[i];

                    this.records.push(subaccount);
                }

                this.loading = false;
            },

            methods: {
                async refresh() {
                    this.loading = true;

                    // fetch and persist subaccounts to db
                    await store.reloadSubaccounts({persist: true});

                    this.loading = false;
                },

                localDate(milliseconds) {
                    return localDate(milliseconds);
                }
            },
        };

        // account info component
        const AccountInfo = {
            template: "#account-info",

            data() {
                return {
                    loading: true,
                    error: "",
                    records: [],
                    active_account_sid: store.getActiveAccountSid(),
                    accounts: store.getAccounts(),
                };
            },

            async created() {
                // refresh data from api
                this.refresh();
            },

            watch: {
                active_account_sid(newValue) {
                    this.active_account_sid = store.active_account_sid = newValue;

                    // refresh data from api
                    this.refresh();
                }
            },

            methods: {
                async refresh(cache) {
                    this.loading = true;

                    const [error, result] = await callTwilioAPI({path: `/2010-04-01/Accounts/${this.active_account_sid}.json`, cache: cache});

                    if (error) {
                        this.error = error;
                    } else {
                        this.records = toLabelValArray(result, ["sid", "owner_account_sid", "friendly_name", "type", "status", "date_created", "date_updated"]);;
                    }

                    this.loading = false;
                },

                localDate(dtStr) {
                    return localDate(dtStr);
                }
            },
        };

        // phone numbers component
        const PhoneNumbers = {
            template: "#phone-numbers",

            data() {
                return {
                    loading: true,
                    error: "",
                    records: [],
                    active_account_sid: store.getActiveAccountSid(),
                    accounts: store.getAccounts(),
                };
            },

            async created() {
                // refresh data from api
                this.refresh();
            },

            watch: {
                active_account_sid(newValue) {
                    this.active_account_sid = store.active_account_sid = newValue;

                    // refresh data from api
                    this.refresh();
                }
            },

            methods: {
                async refresh(cache) {
                    this.loading = true;

                    const [error, result] = await callTwilioAPI({path: `/2010-04-01/Accounts/${this.active_account_sid}/IncomingPhoneNumbers.json`, cache: cache});

                    if (error) {
                        this.error = error;
                    } else {
                        this.records = result.incoming_phone_numbers;
                    }

                    this.loading = false;
                },

                urls(obj) {
                    return toLabelValArray(obj, ["sms_url", "sms_fallback_url", "voice_url", "voice_fallback_url", "status_callback"]);
                },

                capabilities(obj) {
                    return toLabelValArray(obj, ["sms", "mms", "voice"]);
                },

                localDate(dtStr) {
                    return localDate(dtStr);
                }
            },
        };

        // messaging services component
        const MessagingServices = {
            template: "#messaging-services",

            data() {
                return {
                    loading: true,
                    error: "",
                    records: [],
                    active_account_sid: store.getActiveAccountSid(),
                    accounts: store.getAccounts(),
                };
            },

            async created() {
                // refresh data from api
                this.refresh();
            },

            watch: {
                active_account_sid(newValue) {
                    this.active_account_sid = store.active_account_sid = newValue;

                    // refresh data from api
                    this.refresh();
                }
            },

            methods: {
                async refresh(cache) {
                    this.loading = true;

                    const [error, result] = await callTwilioAPI({baseUrl: "https://messaging.twilio.com/v1", path: `/Services?AccountSID=${this.active_account_sid}`, cache: cache});

                    if (error) {
                        this.error = error;
                    } else {
                        this.records = result.services;
                    }

                    this.loading = false;
                },

                urls(obj) {
                    return toLabelValArray(obj, ["inbound_request_url", "inbound_method", "fallback_url", "fallback_method", "status_callback", "use_inbound_webhook_on_number"]);
                },

                settings(obj) {
                    return toLabelValArray(obj, ["area_code_geomatch", "fallback_to_long_code", "smart_encoding", "sticky_sender", "mms_converter", "us_app_to_person_registered", "usecase", "validity_period"]);
                },

                localDate(dtStr) {
                    return localDate(dtStr);
                }
            },
        };

        // message history component
        const MessageHistory = {
            template: "#message-history",

            data() {
                return {
                    loading: true,
                    loading_more: false,
                    searching: false,
                    form: {
                        from: "",
                        to: "",
                        from_date: "",
                        to_date: "",
                    },
                    error: "",
                    records: [],
                    page_size: 20,
                    next_page_uri: "",
                    active_account_sid: store.getActiveAccountSid(),
                    accounts: store.getAccounts(),
                };
            },

            async created() {
                this.refresh();
            },

            watch: {
                active_account_sid(newValue) {
                    this.active_account_sid = store.active_account_sid = newValue;

                    // refresh data from api
                    this.refresh();
                }
            },

            methods: {
                async fetchData({path, cache, appendResults}) {
                    const [error, result] = await callTwilioAPI({path, cache});

                    if (error) {
                        this.error = error;
                        this.next_page_uri = "";
                    } else {
                        if (appendResults) {
                            result.messages.forEach(x => this.records.push(x));
                        } else {
                            this.records = result.messages;
                        }
                        this.next_page_uri = result.next_page_uri;
                    }
                },

                async refresh(cache) {
                    this.loading = true;

                    await this.fetchData({path: `/2010-04-01/Accounts/${this.active_account_sid}/Messages.json?PageSize=${this.page_size}`, cache: cache});

                    this.loading = false;
                },

                async search() {
                    const form = this.form;

                    if (!form.from && !form.to && !form.from_date && !form.to_date) {
                        return this.refresh();
                    }

                    this.next_page_uri = "";
                    this.searching = true;

                    const searchList = [];
                    if (form.from) {
                        searchList.push(`From=${form.from}`);
                    }
                    if (form.to) {
                        searchList.push(`To=${form.to}`);
                    }
                    if (form.from_date) {
                        searchList.push(`DateSent>=${form.from_date}`);
                    }
                    if (form.to_date) {
                        searchList.push(`DateSent<=${form.to_date}`);
                    }
                    const searchStr = searchList.join("&");

                    await this.fetchData({path: `/2010-04-01/Accounts/${this.active_account_sid}/Messages.json?PageSize=${this.page_size}&${searchStr}`, cache: "reload"});

                    this.searching = false;
                },

                loadMore() {
                    if (!this.next_page_uri || this.loading_more) {
                        return;
                    }

                    this.loading_more = true;

                    setTimeout(async () => {
                        await this.fetchData({path: this.next_page_uri, appendResults: true});

                        this.loading_more = false;
                    }, 500);
                },

                price(record) {
                    const formattedPrice = record.price ? formatPrice(record.price) : "-";

                    return `${record.price_unit.toUpperCase()} ${formattedPrice}`;
                },

                localDate(dtStr) {
                    return localDate(dtStr);
                },

                hasMedia(val) {
                    return parseInt(val || "0") > 0;
                },

                async refreshMediaList(sid) {
                    // find the message record
                    const message = this.records.find(x => x.sid === sid);

                    if (!message) {
                        return;
                    }

                    // show spinner
                    message.media_loading = true;

                    const [error, result] = await callTwilioAPI({path: message.subresource_uris.media});

                    if (result) {
                        // for each media create a URL entry
                        message.media_list = result.media_list;

                        message.media_list.forEach(m => {
                            m.link = `https://api.twilio.com${m.uri.replace(".json", "")}`;
                        });

                        // hide spinner
                        message.media_loading = false;
                    }
                },

                icon(contentType) {
                    if (contentType.startsWith("image")) {
                        return "mdi-file-image";
                    }

                    if (contentType.startsWith("video")) {
                        return "mdi-file-video";
                    }

                    if (contentType.startsWith("audio")) {
                        return "mdi-file-music";
                    }

                    return "mdi-file";
                },

                errorPageUrl(code) {
                    return `https://www.twilio.com/docs/errors/${code}`;
                }
            },
        };

        // voice call history component
        const VoiceCallHistory = {
            template: "#voice-call-history",

            data() {
                return {
                    loading: true,
                    loading_more: false,
                    searching: false,
                    form: {
                        from: "",
                        to: "",
                        from_date: "",
                        to_date: "",
                    },
                    error: "",
                    records: [],
                    page_size: 20,
                    next_page_uri: "",
                    active_account_sid: store.getActiveAccountSid(),
                    accounts: store.getAccounts(),
                };
            },

            async created() {
                this.refresh();
            },

            watch: {
                active_account_sid(newValue) {
                    this.active_account_sid = store.active_account_sid = newValue;

                    // refresh data from api
                    this.refresh();
                }
            },

            methods: {
                async fetchData({path, cache, appendResults}) {
                    const [error, result] = await callTwilioAPI({path, cache});

                    if (error) {
                        this.error = error;
                        this.next_page_uri = "";
                    } else {
                        if (appendResults) {
                            result.calls.forEach(x => this.records.push(x));
                        } else {
                            this.records = result.calls;
                        }
                        this.next_page_uri = result.next_page_uri;
                    }
                },

                async refresh(cache) {
                    this.loading = true;

                    await this.fetchData({path: `/2010-04-01/Accounts/${this.active_account_sid}/Calls.json?PageSize=${this.page_size}`, cache: cache});

                    this.loading = false;
                },

                async search() {
                    const form = this.form;

                    if (!form.from && !form.to && !form.from_date && !form.to_date) {
                        return this.refresh();
                    }

                    this.next_page_uri = "";
                    this.searching = true;

                    const searchList = [];
                    if (form.from) {
                        searchList.push(`From=${form.from}`);
                    }
                    if (form.to) {
                        searchList.push(`To=${form.to}`);
                    }
                    if (form.from_date) {
                        searchList.push(`StartTime>=${form.from_date}`);
                    }
                    if (form.to_date) {
                        searchList.push(`EndTime<=${form.to_date}`);
                    }
                    const searchStr = searchList.join("&");

                    await this.fetchData({path: `/2010-04-01/Accounts/${this.active_account_sid}/Calls.json?PageSize=${this.page_size}&${searchStr}`, cache: "reload"});

                    this.searching = false;
                },

                loadMore() {
                    if (!this.next_page_uri || this.loading_more) {
                        return;
                    }

                    this.loading_more = true;

                    setTimeout(async () => {
                        await this.fetchData({path: this.next_page_uri, appendResults: true});

                        this.loading_more = false;
                    }, 500);
                },

                duration(val) {
                    return val + "s";
                },

                price(record) {
                    const formattedPrice = record.price ? formatPrice(record.price) : "-";

                    return `${record.price_unit.toUpperCase()} ${formattedPrice}`;
                },

                localDate(dtStr) {
                    return localDate(dtStr);
                }
            },
        };

        // alerts component
        const Alerts = {
            template: "#alerts",

            data() {
                return {
                    log_level_options: [
                        {label: "All levels", value: ""},
                        {label: "Error", value: "error"},
                        {label: "Warning", value: "warning"},
                        {label: "Notice", value: "notice"},
                        {label: "Debug", value: "debug"},
                    ],
                    loading: true,
                    loading_more: false,
                    searching: false,
                    form: {
                        log_level: "",
                        from_date: "",
                        to_date: "",
                    },
                    error: "",
                    records: [],
                    page_size: 20,
                    next_page_url: "",
                    active_account_sid: store.account_sid,
                    accounts: store.getAccounts(),
                };
            },

            async created() {
                this.refresh();
            },

            methods: {
                async fetchData({baseUrl, path, cache, appendResults}) {
                    const [error, result] = await callTwilioAPI({baseUrl, path, cache});

                    if (error) {
                        this.error = error;
                        this.next_page_url = "";
                    } else {
                        if (appendResults) {
                            result.alerts.forEach(x => this.records.push(x));
                        } else {
                            this.records = result.alerts;
                        }
                        this.next_page_url = result.meta?.next_page_url;
                    }
                },

                async refresh(cache) {
                    this.loading = true;

                    await this.fetchData({baseUrl: "https://monitor.twilio.com/v1", path: `/Alerts?AccountSID=${this.active_account_sid}&PageSize=${this.page_size}`, cache: cache});

                    this.loading = false;
                },

                async search() {
                    const form = this.form;

                    if (!form.log_level && !form.from_date && !form.to_date) {
                        return this.refresh();
                    }

                    this.next_page_url = "";
                    this.searching = true;

                    const searchList = [];
                    if (form.log_level) {
                        searchList.push(`LogLevel=${form.log_level}`);
                    }
                    if (form.from_date) {
                        searchList.push(`StartDate=${form.from_date}`);
                    }
                    if (form.to_date) {
                        searchList.push(`EndDate=${form.to_date}`);
                    }
                    const searchStr = searchList.join("&");

                    await this.fetchData({baseUrl: "https://monitor.twilio.com/v1", path: `/Alerts?AccountSid=${this.active_account_sid}&PageSize=${this.page_size}&${searchStr}`, cache: "reload"});

                    this.searching = false;
                },

                loadMore() {
                    if (!this.next_page_url || this.loading_more) {
                        return;
                    }

                    this.loading_more = true;

                    setTimeout(async () => {
                        await this.fetchData({baseUrl: this.next_page_url, path: "", appendResults: true});

                        this.loading_more = false;
                    }, 500);
                },

                localDate(dtStr) {
                    return localDate(dtStr);
                },

                alertTextTokens(val) {
                    if (!val) {
                        return [{value: "None"}];
                    }

                    const tokens = val.split("&");

                    if (tokens?.length) {
                        return tokens.map(x => {
                            const keyVal = x.split("=");

                            const result = {
                                label: keyVal[0],
                            };

                            if (keyVal.length > 1) {
                                result.value = decodeURIComponent(keyVal[1]).replace(/\+/g, " ");
                            }

                            return result;
                        });
                    }

                    return [{label: val}];
                }
            },
        };

        // events component
        const Events = {
            template: "#events",

            data() {
                return {
                    loading: true,
                    loading_more: false,
                    searching: false,
                    form: {
                        event_type: "",
                        resource_sid: "",
                        from_date: "",
                        to_date: "",
                    },
                    error: "",
                    records: [],
                    page_size: 20,
                    next_page_url: "",
                    active_account_sid: store.account_sid,
                    accounts: store.getAccounts(),
                };
            },

            async created() {
                this.refresh();
            },

            methods: {
                async fetchData({baseUrl, path, cache, appendResults}) {
                    const [error, result] = await callTwilioAPI({baseUrl, path, cache});

                    if (error) {
                        this.error = error;
                        this.next_page_url = "";
                    } else {
                        if (appendResults) {
                            result.events.forEach(x => this.records.push(x));
                        } else {
                            this.records = result.events;
                        }
                        this.next_page_url = result.meta?.next_page_url;
                    }
                },

                async refresh(cache) {
                    this.loading = true;

                    await this.fetchData({baseUrl: "https://monitor.twilio.com/v1", path: `/Events?AccountSid=${this.active_account_sid}&PageSize=${this.page_size}`, cache: cache});

                    this.loading = false;
                },

                async search() {
                    const form = this.form;

                    if (!form.event_type && !form.resource_sid && !form.from_date && !form.to_date) {
                        return this.refresh();
                    }

                    this.next_page_url = "";
                    this.searching = true;

                    const searchList = [];
                    if (form.event_type) {
                        searchList.push(`EventType=${form.event_type}`);
                    }
                    if (form.resource_sid) {
                        searchList.push(`ResourceSid=${form.resource_sid}`);
                    }
                    if (form.from_date) {
                        searchList.push(`StartDate=${form.from_date}`);
                    }
                    if (form.to_date) {
                        searchList.push(`EndDate=${form.to_date}`);
                    }
                    const searchStr = searchList.join("&");

                    await this.fetchData({baseUrl: "https://monitor.twilio.com/v1", path: `/Events?AccountSid=${this.active_account_sid}&PageSize=${this.page_size}&${searchStr}`, cache: "reload"});

                    this.searching = false;
                },

                loadMore() {
                    if (!this.next_page_url || this.loading_more) {
                        return;
                    }

                    this.loading_more = true;

                    setTimeout(async () => {
                        await this.fetchData({baseUrl: this.next_page_url, path: "", appendResults: true});

                        this.loading_more = false;
                    }, 500);
                },

                localDate(dtStr) {
                    return localDate(dtStr);
                },

                actor(record) {
                    let result = record.actor_type;

                    if (record.actor_sid) {
                        result += " - " + record.actor_sid;
                    }

                    return result;
                },

                eventDataItems(val) {
                    if (!val) {
                        return [{value: "None"}];
                    }

                    const flatObj = flattenObject(val);

                    return toLabelValArray(flatObj, Object.keys(flatObj));
                }
            },
        };

        // billing component
        const Billing = {
            template: "#billing",

            data() {
                return {
                    loading: true,
                    refreshingBalance: true,
                    form: {
                        from_date: "",
                        to_date: "",
                        include_subaccounts: false,
                    },
                    error: "",
                    balance: {},
                    records: [],
                    totals_record: {},
                    page_size: 1000,
                    active_account_sid: store.account_sid,
                    accounts: store.getAccounts(),
                };
            },

            created() {
                const defaultDts = this.defaultDates();

                // read preference and assing default values if needed
                const lsFromDate = localStorage.getItem("billing_search_from_date");
                this.form.from_date = lsFromDate ? lsFromDate : defaultDts.from_date;

                const lsToDate = localStorage.getItem("billing_search_to_date");
                this.form.to_date = lsToDate ? lsToDate : defaultDts.to_date;

                this.form.include_subaccounts = (localStorage.getItem("billing_search_include_subaccounts") === "true") ? true : false;

                this.balanceRefresh();
                this.refresh();
            },

            watch: {
                'form.from_date'(newValue) {
                    localStorage.setItem("billing_search_from_date", newValue);
                },
                'form.to_date'(newValue) {
                    localStorage.setItem("billing_search_to_date", newValue);
                },
                'form.include_subaccounts'(newValue) {
                    localStorage.setItem("billing_search_include_subaccounts", newValue);
                },
                active_account_sid(newValue) {
                    this.active_account_sid = store.active_account_sid = newValue;

                    // refresh data from api
                    this.refresh();
                }
            },

            methods: {
                defaultDates() {
                    const toDate = new Date();
                    const fromDate = new Date(toDate.getFullYear(), toDate.getMonth(), 1);

                    return {
                        from_date: fromDate.toLocaleDateString("fr-ca"),
                        to_date: toDate.toLocaleDateString("fr-ca")
                    };
                },

                setDates(option) {
                    const today = new Date();
                    let quarter = Math.floor((today.getMonth() / 3));
                    let toDate, fromDate;

                    switch (option) {
                        case "tm":
                            toDate = today;
                            fromDate = new Date(toDate.getFullYear(), toDate.getMonth(), 1);
                            break;

                        case "lm":
                            fromDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                            toDate = new Date(fromDate.getFullYear(), fromDate.getMonth() + 1, 0);
                            break;

                        case "tq":
                            fromDate = new Date(today.getFullYear(), quarter * 3, 1);
                            toDate = today;
                            break;

                        case "lq":
                            fromDate = new Date(today.getFullYear(), quarter * 3 - 3, 1);
                            toDate = new Date(fromDate.getFullYear(), fromDate.getMonth() + 3, 0);
                            break;

                        case "ty":
                            fromDate = new Date(today.getFullYear(), 0, 1);
                            toDate = today;
                            break;

                        case "ly":
                            fromDate = new Date(today.getFullYear() - 1, 0, 1);
                            toDate = new Date(fromDate.getFullYear(), 11, 31);
                            break;

                        default:
                            return;
                    }

                    this.form.from_date = fromDate.toLocaleDateString("fr-ca");
                    this.form.to_date = toDate.toLocaleDateString("fr-ca");
                },

                async balanceRefresh(cache) {
                    this.refreshingBalance = true;

                    // get balance
                    const [error, result] = await callTwilioAPI({path: `/2010-04-01/Accounts/${this.active_account_sid}/Balance.json`, cache: cache});

                    if (error) {
                        this.error = error;
                    } else {
                        this.balance = result;
                    }

                    this.refreshingBalance = false;
                },

                async refresh(cache) {
                    this.loading = true;
                    this.records = [];

                    // get usage
                    const params = [];
                    if (this.form.from_date) {
                        params.push(`StartDate=${this.form.from_date}`);
                    }
                    if (this.form.to_date) {
                        params.push(`EndDate=${this.form.to_date}`);
                    }
                    const includeSubaccounts = (this.form.include_subaccounts) ? "true" : "false";
                    params.push(`IncludeSubaccounts=${includeSubaccounts}`);

                    const paramStr = params.join("&");

                    const [error, result] = await callTwilioAPI({path: `/2010-04-01/Accounts/${this.active_account_sid}/Usage/Records.json?PageSize=${this.page_size}&${paramStr}`, cache: cache});

                    if (error) {
                        this.error = error;
                    } else {
                        // filter and map results
                        let usage = [];

                        result.
                            usage_records.
                            filter(x => parseInt(x.usage) > 0 || parseInt(x.count) > 0).
                            map(x => {
                                const categoryMap = billingCategoryMap.get(x.category) || billingCategoryMap.get("other");

                                return {...x, ...categoryMap};
                            }).
                            filter(x => !x.ignore).
                            sort((a, b) => a.level - b.level).
                            forEach(x => {
                                if (x.category === "totalprice") {
                                    // total price record is stored separately
                                    this.totals_record = x;
                                }
                                else {
                                    // all other records
                                    let groupChildren = usage.find(y => y.group === x.group)?.children;
                                    if (!groupChildren) {
                                        groupChildren = [];
                                        usage.push({group: x.group, children: groupChildren});
                                    }

                                    // find first item with higher order than this entry
                                    const nextItemIndex = groupChildren.findIndex(y => y.order > x.order);

                                    if (nextItemIndex >= 0) {
                                        groupChildren.splice(nextItemIndex, 0, x);
                                    } else {
                                        groupChildren.push(x);
                                    }
                                }
                            });

                        // sort final records by group, and add to state
                        usage.
                            sort((a, b) => a.group.localeCompare(b.group)).
                            forEach(x => this.records.push(x));
                    }

                    this.loading = false;
                },

                balanceStr() {
                    return `${this.balance?.currency} ${this.balance?.balance || "-"}`;
                },

                count(record) {
                    const cnt = (record.count) ? parseInt(record.count) : 0;

                    return (record.count_unit) ? `${cnt} (${record.count_unit})` : cnt;
                },

                usage(record) {
                    const cnt = (record.usage) ? parseInt(record.usage) : 0;

                    return (record.usage_unit) ? `${cnt} (${record.usage_unit})` : cnt;
                },

                price(record) {
                    const formattedPrice = record.price ? formatPrice(record.price) : "-";

                    return `${record.price_unit.toUpperCase()} ${formattedPrice}`;
                },

                localDate(dtStr) {
                    return localDate(dtStr);
                }
            },
        };

        // routing
        const routes = [
            {path: "/", name: "Auth", component: Auth, meta: {icon: "mdi-key-variant", showInNav: true}},
            {path: "/subaccounts/:owner_account_sid", name: "Subaccounts", component: Subaccounts, meta: {showInNav: false}},
            {path: "/account-info", name: "Account info", component: AccountInfo, meta: {icon: "mdi-information", showInNav: true}},
            {path: "/phone-numbers", name: "Phone numbers", component: PhoneNumbers, meta: {icon: "mdi-phone", showInNav: true}},
            {path: "/messaging-services", name: "Messaging services", component: MessagingServices, meta: {icon: "mdi-message-text-fast", showInNav: true}},
            {path: "/message-history", name: "Message history", component: MessageHistory, meta: {icon: "mdi-message-bulleted", showInNav: true}},
            {path: "/voice-call-history", name: "Voice call history", component: VoiceCallHistory, meta: {icon: "mdi-microphone-settings", showInNav: true}},
            {path: "/alerts", name: "Alerts", component: Alerts, meta: {icon: "mdi-alert", showInNav: true}},
            {path: "/events", name: "Events", component: Events, meta: {icon: "mdi-delta", showInNav: true}},
            {path: "/billing", name: "Billing", component: Billing, meta: {icon: "mdi-receipt-text", showInNav: true}}
        ];

        const navItems = routes.filter(x => x.meta.showInNav);

        const router = createRouter({
            history: createWebHistory(),
            routes: routes.map(x => ({path: x.path, name: x.name, component: x.component || {template: `#${x.templateID}`}})),
        })

        const DEFAULT_TITLE = "Twilio Viewer";
        router.afterEach((to, from) => {
            // Use next tick to handle router history correctly
            // see: https://github.com/vuejs/vue-router/issues/914#issuecomment-384477609
            nextTick(() => {
                if (to.name === "Auth") {
                    document.title = DEFAULT_TITLE;
                } else {
                    document.title = `${to.name} | ${DEFAULT_TITLE}`;
                }
            });
        });

        // vuetify
        const vuetify = createVuetify();

        // creat vue app
        const app = createApp({
            data() {
                return {
                    navItems,
                }
            },

            computed: {
                appBarTitle() {
                    return this.$route.name;
                }
            },

            methods: {
                reloadWebsite() {
                    location.replace("/");
                },
            },
        });

        app.use(router);
        app.use(vuetify);

        app.mount("#app");
    </script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3EZVFZYBLT"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() {dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-3EZVFZYBLT');
    </script>
</body>